<view class="page-container">
  <t-navbar title="{{deckTitle}}" left-arrow bind:go-back="onBack" style="--td-navbar-bg-color: transparent;" />

  <view class="search-bar">
    <t-search
      value="{{keyword}}"
      placeholder="æœç´¢æ­¤å¡ç»„"
      clearable
      bind:change="onSearchChange"
    />
  </view>

  <scroll-view scroll-y class="card-list">
    <block wx:for="{{displayCards}}" wx:key="id">
      <view class="library-item" bind:tap="onCardTap" data-id="{{item.id}}">
        <view class="item-content">
          <view class="item-title">{{item.question}}</view>
          <view class="item-tags" wx:if="{{item.tags && item.tags.length}}">
            <view class="tag-box" wx:for="{{item.tags}}" wx:for-item="tag" wx:key="*this">
              {{tag}}
            </view>
          </view>
        </view>
        <view class="item-arrow">
          <t-icon name="chevron-right" size="40rpx" color="var(--c-text-light)" />
        </view>
      </view>
    </block>

    <t-empty wx:if="{{!displayCards.length}}" icon="info-circle-filled" description="æ­¤å¡ç»„æš‚æ— å¡ç‰‡" />
  </scroll-view>

  <t-popup
    visible="{{detailVisible}}"
    placement="bottom"
    bind:visible-change="onPopupClose"
    custom-style="height: 85vh"
  >
    <view class="detail-container" wx:if="{{currentCard}}">
      <view class="detail-header">
        <view class="q-title">{{currentCard.question}}</view>
        <t-icon wx:if="{{currentCard.sourceImages && currentCard.sourceImages.length}}" name="image" size="24" />
      </view>

      <scroll-view scroll-y class="detail-content">
        <block wx:if="{{currentCard.sourceImageUrls && currentCard.sourceImageUrls.length}}">
          <image wx:for="{{currentCard.sourceImageUrls}}" wx:key="index" class="detail-image" src="{{item}}" mode="widthFix" />
        </block>
        <block wx:for="{{currentCard.answerSections}}" wx:key="index">
          <view class="section-block">
            <view class="section-title">{{item.title || item.type}}</view>
            <view wx:if="{{item.type === 'formula' && item.latex}}" class="formula-box">
              {{item.latex}}
            </view>
            <view wx:elif="{{item.content}}" class="text-content">
              {{item.content}}
            </view>
            <view wx:else class="text-muted">æš‚æ— å†…å®¹</view>
          </view>
          <t-divider />
        </block>

        <view wx:if="{{currentCard.memoryHint}}" class="memory-hint">
          <text class="hint-icon">ðŸ’¡</text>
          <text class="hint-text">{{currentCard.memoryHint}}</text>
        </view>

        <view class="review-actions">
          <t-button theme="danger" variant="outline" block data-level="forget" bind:tap="onMemoryAction">å¿˜è®°</t-button>
          <t-button theme="primary" variant="outline" block data-level="remember" bind:tap="onMemoryAction">è®°å¾—</t-button>
        </view>
      </scroll-view>
    </view>
  </t-popup>

  <t-fab icon="add" bind:click="onAddCard" aria-label="æ–°å»ºå¡ç‰‡" />
</view>


