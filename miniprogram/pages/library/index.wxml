<view class="page-container">
  <t-navbar title="å¡åŒ…" left-arrow="{{false}}" />

  <view class="search-bar">
    <t-search
      value="{{keyword}}"
      placeholder="æœç´¢å¡ç‰‡"
      clearable
      bind:change="onSearchChange"
      bind:clear="onSearchClear"
      bind:submit="onSearchSubmit"
    />
  </view>

  <t-tabs value="{{activeTab}}" theme="tag" bind:change="onTabChange">
    <t-tab-panel label="å…¨éƒ¨" value="all" />
    <t-tab-panel label="å¾®è§‚" value="micro" />
    <t-tab-panel label="å®è§‚" value="macro" />
  </t-tabs>

  <scroll-view scroll-y class="card-list">
    <block wx:for="{{displayCards}}" wx:key="id">
      <view class="card-item" bind:tap="onCardTap" data-id="{{item.id}}">
        <view class="card-header">
          <text class="card-question">{{item.question}}</text>
          <view class="card-tags" wx:if="{{item.tags && item.tags.length}}">
            <t-tag wx:for="{{item.tags}}" wx:for-item="tag" wx:key="*this" size="small" variant="light">
              {{tag}}
            </t-tag>
          </view>
        </view>
        <view class="card-subtitle">{{item.subtitle}}</view>
      </view>
    </block>

    <t-empty wx:if="{{!displayCards.length}}" icon="info-circle-filled" description="æš‚æ— å¡ç‰‡" />
  </scroll-view>

  <t-popup
    visible="{{detailVisible}}"
    placement="bottom"
    bind:visible-change="onPopupClose"
    custom-style="height: 85vh"
  >
    <view class="detail-container" wx:if="{{currentCard}}">
      <view class="detail-header">
        <view class="q-title">{{currentCard.question}}</view>
        <t-icon wx:if="{{currentCard.sourceImage}}" name="image" size="24" />
      </view>

      <scroll-view scroll-y class="detail-content">
        <image wx:if="{{currentCard.sourceImageUrl}}" class="detail-image" src="{{currentCard.sourceImageUrl}}" mode="widthFix" />
        <block wx:for="{{currentCard.answerSections}}" wx:key="index">
          <view class="section-block">
            <view class="section-title">{{item.title}}</view>
            <view wx:if="{{item.type === 'formula' && item.latex}}" class="formula-box">
              {{item.latex}}
            </view>
            <view wx:elif="{{item.content}}" class="text-content">
              {{item.content}}
            </view>
            <view wx:else class="text-muted">æš‚æ— å†…å®¹</view>
          </view>
          <t-divider />
        </block>

        <view wx:if="{{currentCard.memoryHint}}" class="memory-hint">
          <text class="hint-icon">ðŸ’¡</text>
          <text class="hint-text">{{currentCard.memoryHint}}</text>
        </view>

        <view class="review-actions">
          <t-button theme="danger" variant="outline" block data-level="forget" bind:tap="onMemoryAction">å¿˜è®°</t-button>
          <t-button theme="primary" variant="outline" block data-level="remember" bind:tap="onMemoryAction">è®°å¾—</t-button>
        </view>
      </scroll-view>
    </view>
  </t-popup>

  <t-fab icon="add" bind:click="onAddCard" aria-label="æ–°å»ºå¡ç‰‡" />
</view>
