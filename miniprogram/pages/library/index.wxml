<view
  class="lc-root {{theme === 'dark' ? 'lc-theme-dark' : ''}}"
  style="--lc-status-bar: {{statusBarRpx}}rpx; --lc-safe-bottom: {{safeBottomRpx}}rpx;"
>
  <!-- Fixed Header (matches ui/Layout) -->
  <view class="lc-header">
    <view class="lc-header-inner">
      <text class="lc-header-title">LearnCards</text>
    </view>
  </view>

  <view class="lc-main">
    <view class="lc-container create-container">
      <view class="create-title-block">
        <view class="lc-h1">Create New Deck</view>
        <view class="lc-p">Choose how to create your flashcards</view>
      </view>

      <!-- Step Indicator -->
      <view class="step-row">
        <block wx:for="{{stepLabels}}" wx:key="*this">
          <view class="step-item">
            <view class="step-line {{index <= currentStepIndex ? 'is-active' : ''}}" />
            <view class="step-dot {{index <= currentStepIndex ? 'is-active' : ''}}">
              {{index + 1}}
            </view>
          </view>
        </block>
      </view>

      <!-- Step 0: Choose Source (Local or Community) -->
      <view wx:if="{{step === 'source'}}" class="create-section">
        <view class="create-section-title">Choose creation source</view>
        <view class="source-list">
          <view class="source-item" data-source="local" bind:tap="onSelectSource" hover-class="lc-hover-border">
            <view class="source-icon">
              <text class="source-emoji">üìù</text>
            </view>
            <view class="source-info">
              <view class="source-label">Local Deck</view>
              <view class="source-desc">Create from your own content</view>
            </view>
            <text class="source-arrow">‚Ä∫</text>
          </view>

          <view class="source-item" data-source="community" bind:tap="onSelectSource" hover-class="lc-hover-border">
            <view class="source-icon">
              <text class="source-emoji">üåê</text>
            </view>
            <view class="source-info">
              <view class="source-label">Community</view>
              <view class="source-desc">Browse &amp; collect shared decks</view>
            </view>
            <text class="source-arrow">‚Ä∫</text>
          </view>
        </view>
      </view>

      <!-- Step 1: Mode Selection (Local) -->
      <view wx:elif="{{step === 'mode'}}" class="create-section">
        <view class="create-section-title">Choose input method</view>
        <view class="mode-list">
          <view
            wx:for="{{modes}}"
            wx:key="id"
            class="mode-item"
            data-id="{{item.id}}"
            bind:tap="onSelectMode"
            hover-class="lc-hover-border"
          >
            <view class="mode-icon">
              <t-icon name="{{item.icon}}" size="48rpx" color="var(--lc-primary)" />
            </view>
            <view class="mode-info">
              <view class="mode-label">{{item.label}}</view>
              <view class="mode-desc">{{item.desc}}</view>
            </view>
          </view>
        </view>
      </view>

      <!-- Input Step -->
      <view wx:elif="{{step === 'input'}}" class="create-section">
        <view class="field-block">
          <view class="field-label">Subject (Â≠¶Áßë)</view>
          <scroll-view scroll-x class="subject-chip-scroll" show-scrollbar="{{false}}">
            <view class="lc-chip-row">
              <view
                class="lc-chip {{!subjectTag ? 'is-active' : ''}}"
                data-subject=""
                bind:tap="onSubjectTap"
                hover-class="lc-hover-border"
              >
                Auto
              </view>
              <view
                wx:for="{{subjectCandidates}}"
                wx:key="*this"
                class="lc-chip {{subjectTag === item ? 'is-active' : ''}}"
                data-subject="{{item}}"
                bind:tap="onSubjectTap"
                hover-class="lc-hover-border"
              >
                {{item}}
              </view>
            </view>
          </scroll-view>
          <view class="lc-p" style="margin-top: 12rpx;">
            Deck tag ‰ªÖÁî®‰∫éÂ≠¶ÁßëÁ≠õÈÄâÔºõÂç°ÁâáÁ±ªÂûãÂ∞ÜÁî± AI Ëá™Âä®Âà§Êñ≠„ÄÇ
          </view>
        </view>

        <view class="field-block">
          <view class="field-label">Deck Title</view>
          <input
            class="lc-input"
            placeholder="e.g., Quantum Mechanics Chapter 5"
            placeholder-class="home-placeholder"
            value="{{deckTitle}}"
            bindinput="onDeckTitleInput"
          />
        </view>

        <view wx:if="{{selectedMode === 'text'}}" class="field-block">
          <view class="field-label">Content</view>
          <textarea
            class="lc-input textarea"
            placeholder="Paste your text content here..."
            placeholder-class="home-placeholder"
            value="{{inputText}}"
            bindinput="onInputText"
          />
        </view>

        <view
          wx:elif="{{selectedMode === 'scan' || selectedMode === 'upload'}}"
          class="upload-box"
          bind:tap="onPickImage"
          hover-class="lc-hover-bg"
        >
          <t-icon name="{{selectedMode === 'scan' ? 'scan' : 'upload'}}" size="96rpx" color="var(--lc-text-subtle)" />
          <view class="upload-title">{{selectedMode === 'scan' ? 'Take a photo' : 'Click to upload'}}</view>
          <view class="upload-sub">{{selectedMode === 'scan' ? 'or select from gallery' : 'or drag and drop files here'}}</view>
          <view wx:if="{{pickedImages.length}}" class="upload-picked">
            <text>Selected: {{pickedImages.length}} images</text>
            <button class="upload-clear-btn" catch:tap="onClearImages" hover-class="lc-hover-bg">Clear</button>
          </view>
          <view wx:else class="upload-picked">Up to 9 images</view>
        </view>

        <view class="field-block" style="margin-top: 24rpx;">
          <view class="field-label">Knowledge (optional)</view>
          <view wx:if="{{isFeynmanEntry}}" class="lc-p" style="margin-bottom: 16rpx;">
            Feynman: write what you already know / how you would explain it. AI will generate cards using this context.
          </view>
          <textarea
            class="lc-input textarea"
            placeholder="Optional: your understanding, key points, or what you want to focus on..."
            placeholder-class="home-placeholder"
            value="{{knowledge}}"
            bindinput="onKnowledgeInput"
          />
        </view>

        <button
          class="lc-btn lc-btn-primary create-btn"
          disabled="{{!deckTitle || (selectedMode === 'text' ? !inputText : pickedImages.length === 0)}}"
          bind:tap="onGenerate"
          hover-class="lc-hover-primary"
        >
          <t-icon name="add" size="36rpx" color="#fff" />
          <text style="margin-left: 12rpx;">Generate Cards</text>
        </button>
    </view>

      <!-- Generate Step -->
      <view wx:elif="{{step === 'generate'}}" class="create-section generate-wrap">
        <view class="center">
          <view class="spinner" />
          <view class="generate-title">{{step3Title}}</view>
          <view class="lc-p">{{step3Subtitle}}</view>
        </view>

        <view class="lc-card generate-card">
          <view wx:if="{{uploadTotal > 0}}" class="progress-row">
            <view wx:if="{{uploadDone >= uploadTotal}}" class="check-dot">‚úì</view>
            <view wx:elif="{{step3Phase === 'upload'}}" class="pulse-dot">
              <view class="mini-spinner" />
            </view>
            <view wx:else class="idle-dot" />
            <view class="progress-text">Uploading images {{uploadDone}}/{{uploadTotal}}</view>
          </view>
          <view class="progress-row">
            <view wx:if="{{ocrTotal === 0}}" class="check-dot">‚úì</view>
            <view wx:elif="{{ocrDone >= ocrTotal}}" class="check-dot">‚úì</view>
            <view wx:elif="{{step3Phase === 'ocr'}}" class="pulse-dot">
              <view class="mini-spinner" />
            </view>
            <view wx:else class="idle-dot" />
            <view class="progress-text">
              <block wx:if="{{ocrTotal === 0}}">Content ready</block>
              <block wx:else>Extracting text {{ocrDone}}/{{ocrTotal}}</block>
            </view>
          </view>
          <view class="progress-row">
            <view wx:if="{{writeTotal > 0}}" class="check-dot">‚úì</view>
            <view wx:elif="{{step3Phase === 'generate'}}" class="pulse-dot">
              <view class="mini-spinner" />
            </view>
            <view wx:else class="idle-dot" />
            <view class="progress-text">Generating cards...</view>
          </view>
          <view class="progress-row">
            <view wx:if="{{writeTotal > 0 && writeDone >= writeTotal}}" class="check-dot">‚úì</view>
            <view wx:elif="{{step3Phase === 'write'}}" class="pulse-dot">
              <view class="mini-spinner" />
            </view>
            <view wx:else class="idle-dot" />
            <view class="progress-text">
              <block wx:if="{{writeTotal > 0}}">Saving {{writeDone}}/{{writeTotal}}</block>
              <block wx:else>Waiting to save</block>
            </view>
          </view>
        </view>
      </view>

      <!-- Complete Step -->
      <view wx:elif="{{step === 'complete'}}" class="create-section generate-wrap">
        <view class="center">
          <view class="success-icon">‚úì</view>
          <view class="generate-title">Cards Generated!</view>
          <view class="lc-p">Your knowledge cards are ready to use</view>
        </view>

        <button class="lc-btn lc-btn-primary create-btn" bind:tap="onGoHome">
          <t-icon name="home" size="36rpx" color="#fff" />
          <text style="margin-left: 12rpx;">Go Home</text>
        </button>
      </view>

      <!-- Job History (always visible) -->
      <view class="create-section job-history">
        <view class="create-section-title">Generation History</view>

        <view wx:if="{{isLoadingJobs && !jobs.length}}" class="lc-card jobs-empty">
          <view class="lc-inline-loading">
            <view class="lc-mini-spinner" />
            <text class="jobs-empty-text">Loading jobs...</text>
          </view>
        </view>

        <view wx:elif="{{!jobs.length}}" class="lc-card jobs-empty">
          <text class="jobs-empty-text">No jobs yet.</text>
        </view>

        <view wx:else class="job-list">
          <view
            wx:for="{{jobs}}"
            wx:key="id"
            class="lc-card job-item"
            data-id="{{item.id}}"
            data-deck-title="{{item.deckTitle}}"
            data-status="{{item.status}}"
            bind:tap="onJobTap"
            hover-class="lc-hover-border"
          >
            <view class="job-row">
              <view class="job-title">{{item.deckTitle}}</view>
              <view class="job-badge job-badge-{{item.status}}">{{item.statusLabel}}</view>
            </view>
            <view wx:if="{{item.createdText || item.updatedText}}" class="job-meta">
              <text wx:if="{{item.createdText}}">{{item.createdText}}</text>
              <text wx:elif="{{item.updatedText}}">{{item.updatedText}}</text>
            </view>
            <view wx:if="{{item.status !== 'done'}}" class="job-progress">
              <text class="job-progress-text">
                <block wx:if="{{item.status === 'failed'}}">{{item.error}}</block>
                <block wx:elif="{{item.phase === 'ocr'}}">OCR {{item.ocrDone}}/{{item.ocrTotal}}</block>
                <block wx:elif="{{item.phase === 'write'}}">Saving {{item.writeDone}}/{{item.writeTotal}}</block>
                <block wx:elif="{{item.phase === 'generate'}}">Generating...</block>
                <block wx:else>Queued</block>
              </text>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>
</view>
